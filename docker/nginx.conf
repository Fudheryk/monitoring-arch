# =============================================================================
# NGINX CONFIG - DEV
# monitoring.local / localhost
#
# Objectifs:
# - rediriger HTTP -> HTTPS
# - router / vers web (UI) et /api/v1/* vers api
# - exposer /api/docs et /api/openapi.json en rewrite vers FastAPI
# - propager les headers X-Forwarded-* pour voir l'IP réelle côté app
# - limiter le spam sur /api/v1/ingest/metrics (rate limiting ciblé)
#
# NOTE IMPORTANT:
# - Pour que l'API voie réellement X-Forwarded-For (dans les logs FastAPI/Uvicorn),
#   il faut aussi lancer uvicorn avec --proxy-headers (côté container api).
# =============================================================================

events {}

http {

  # ---------------------------------------------------------------------------
  # Logs utiles en dev (debug de 403 / IP clients)
  # ---------------------------------------------------------------------------
  log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent" '
                  'xff="$http_x_forwarded_for" rid="$request_id"';

  access_log /var/log/nginx/access.log main;
  error_log  /var/log/nginx/error.log warn;
  
  # ---------------------------------------------------------------------------
  # Config rate limiting
  # ---------------------------------------------------------------------------
  # Quand limit_req déclenche, renvoyer 429 (au lieu de 503 par défaut)
  limit_req_status 429;

  # ---------------------------------------------------------------------------
  # Rate limiting ciblé (anti spam sur ingest)
  # - 5 req/s par IP, burst 10
  # - Ajuste si tu as des agents qui envoient beaucoup
  # ---------------------------------------------------------------------------
  limit_req_zone $binary_remote_addr zone=ingest_limit:10m rate=5r/s;
  


  # ---------------------------------------------------------------------------
  # HTTP -> HTTPS redirect
  # ---------------------------------------------------------------------------
  server {
    listen 80;
    server_name monitoring.local localhost;
    return 301 https://$host$request_uri;
  }

  # ---------------------------------------------------------------------------
  # HTTPS server
  # ---------------------------------------------------------------------------
  server {
    listen 443 ssl;
    server_name monitoring.local localhost;

    ssl_certificate     /etc/nginx/certs/monitoring.local.pem;
    ssl_certificate_key /etc/nginx/certs/monitoring.local-key.pem;

    # DNS Docker (important pour re-résoudre api/web après restart)
    resolver 127.0.0.11 ipv6=off valid=10s;
    resolver_timeout 5s;

    # Upstreams (sans chemin ici)
    set $web_upstream http://web:3000;
    set $api_upstream http://api:8000;
    
    # -------------------------------------------------------------------------
    # Rate limiting configuration for this server
    # -------------------------------------------------------------------------
    # Override default 503 with 429 for rate limiting
    limit_req_status 429;
    # Default content type for error responses
    default_type application/json;
    
    # Custom error page for rate limiting (JSON response)
    error_page 429 = @rate_limited;
    
    # Rate limited endpoint (JSON response)
    location @rate_limited {
      return 429 '{"detail":"rate limit exceeded"}';
    }

    # -------------------------------------------------------------------------
    # UI (webapp)
    # -------------------------------------------------------------------------
    location / {
      proxy_pass $web_upstream;

      # Headers de base
      proxy_set_header Host $host;

      # IP réelle client + chaîne de proxy
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      # Proto (ici https forcé)
      proxy_set_header X-Forwarded-Proto https;
    }

    # -------------------------------------------------------------------------
    # API v1 (FastAPI)
    # - on passe tel quel (pas de doublage)
    # -------------------------------------------------------------------------
    location ^~ /api/v1/ {
      proxy_pass $api_upstream;
      proxy_http_version 1.1;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # -------------------------------------------------------------------------
    # Ingest: location exact-match pour appliquer un rate-limit spécifique
    # - L'endpoint reste identique (/api/v1/ingest/metrics)
    # - Optionnel: access_log off si tu veux réduire le bruit
    # -------------------------------------------------------------------------
    location = /api/v1/ingest/metrics {
      limit_req zone=ingest_limit burst=10 nodelay;

      # Client body buffering (ingest specific)
      # - Evite d'écrire le body sur disque pour des payloads ~512KB
      # - Garde une limite de sécurité (ajuste selon ton worst-case)
      client_body_buffer_size 1m;
      client_max_body_size 2m;

      proxy_pass $api_upstream;
      proxy_http_version 1.1;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;

      # access_log off;  # décommente si tu veux couper les logs ingest en dev
    }

    # -------------------------------------------------------------------------
    # Docs : /api/docs -> /docs
    # -------------------------------------------------------------------------
    location = /api/docs {
      rewrite ^ /docs break;
      proxy_pass $api_upstream;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # -------------------------------------------------------------------------
    # OpenAPI : /api/openapi.json -> /openapi.json
    # -------------------------------------------------------------------------
    location = /api/openapi.json {
      rewrite ^ /openapi.json break;
      proxy_pass $api_upstream;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }
  }
}
