events {}

http {
  server {
    listen 80;
    server_name monitoring.local localhost;
    return 301 https://$host$request_uri;
  }

  server {
    listen 443 ssl;
    server_name monitoring.local localhost;

    ssl_certificate     /etc/nginx/certs/monitoring.local.pem;
    ssl_certificate_key /etc/nginx/certs/monitoring.local-key.pem;

    # DNS Docker (important pour re-résoudre api/web après restart)
    resolver 127.0.0.11 ipv6=off valid=10s;
    resolver_timeout 5s;

    # Upstreams (sans chemin ici)
    set $web_upstream http://web:3000;
    set $api_upstream http://api:8000;

    # UI
    location / {
      proxy_pass $web_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # API v1 : on passe tel quel (pas de doublage)
    location ^~ /api/v1/ {
      proxy_pass $api_upstream;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # Docs : /api/docs -> /docs
    location = /api/docs {
      rewrite ^ /docs break;
      proxy_pass $api_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # OpenAPI : /api/openapi.json -> /openapi.json
    location = /api/openapi.json {
      rewrite ^ /openapi.json break;
      proxy_pass $api_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }
  }
}
