# =============================================================================
# Docker Compose - PRODUCTION avec Traefik + Let's Encrypt
# =============================================================================
# CHANGEMENTS vs Nginx:
# - Traefik remplace nginx comme reverse proxy
# - Let's Encrypt automatique (HTTP Challenge) - supprime Certbot
# - Auto-découverte services via labels Docker
# - Dashboard Traefik sécurisé (basicauth)
# - Segmentation réseau: public (traefik+web+status) + private (api+worker+db+redis)
# - Network external: true (best practice)
# =============================================================================

x-app-common: &app-common
  image: ${DOCKER_USERNAME}/monitoring-api:${VERSION:-latest}
  env_file: ../.env.production
  working_dir: /app/server
  restart: always
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  deploy:
    resources:
      limits:
        memory: 200M
      reservations:
        memory: 100M
  security_opt:
    - no-new-privileges:true

services:
  # ---------------------------------------------------------------------------
  # Migration Job (one-off)
  # ---------------------------------------------------------------------------
  migrate:
    <<: *app-common
    command: ["alembic", "-c", "/app/server/alembic.ini", "upgrade", "head"]
    healthcheck:
      disable: true
    environment:
      DATABASE_URL: "postgresql+psycopg://postgres:${DB_PASSWORD}@db:5432/monitoring"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      PGOPTIONS: "-c lock_timeout=5s -c statement_timeout=60000"
    depends_on:
      db:
        condition: service_healthy
    restart: "no"
    networks:
      - private
    deploy:
      resources:
        limits:
          memory: 150M

  # ---------------------------------------------------------------------------
  # API Backend
  # ---------------------------------------------------------------------------
  api:
    <<: *app-common
    command: ["api"]
    environment:
      DATABASE_URL: "postgresql+psycopg://postgres:${DB_PASSWORD}@db:5432/monitoring"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      PROXY_HEADERS: "1"
      FORWARDED_ALLOW_IPS: "127.0.0.1,172.30.0.0/16,172.31.0.0/16"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    stop_signal: SIGINT
    stop_grace_period: 20s
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/api/v1/health')\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - private
    labels:
      # Traefik activation
      - "traefik.enable=true"
      - "traefik.docker.network=monitoring-prod-private"
      
      # Router pour /api/* (neonmonitor.dockl.com)
      - "traefik.http.routers.api.rule=Host(`neonmonitor.dockl.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api.service=api"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
      
      # Rate limiting API général
      - "traefik.http.middlewares.api-ratelimit.ratelimit.average=10"
      - "traefik.http.middlewares.api-ratelimit.ratelimit.burst=20"
      - "traefik.http.middlewares.api-ratelimit.ratelimit.period=1s"
      
      # Rate limiting spécifique ingest (plus permissif)
      - "traefik.http.middlewares.ingest-ratelimit.ratelimit.average=10"
      - "traefik.http.middlewares.ingest-ratelimit.ratelimit.burst=60"
      
      # Router prioritaire pour /api/v1/ingest/* avec rate limit spécifique
      - "traefik.http.routers.api-ingest.rule=Host(`neonmonitor.dockl.com`) && PathPrefix(`/api/v1/ingest`)"
      - "traefik.http.routers.api-ingest.entrypoints=websecure"
      - "traefik.http.routers.api-ingest.tls=true"
      - "traefik.http.routers.api-ingest.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api-ingest.priority=10"
      - "traefik.http.routers.api-ingest.service=api"
      - "traefik.http.routers.api-ingest.middlewares=ingest-ratelimit@docker"
      
      # Rate limit par défaut pour les autres routes API
      - "traefik.http.routers.api.middlewares=api-ratelimit@docker"
    deploy:
      resources:
        limits:
          memory: 180M
        reservations:
          memory: 60M

  # ---------------------------------------------------------------------------
  # Celery Worker
  # ---------------------------------------------------------------------------
  worker:
    <<: *app-common
    command: ["celery", "-A", "app.workers.celery_app.celery", "worker", "-l", "info"]
    environment:
      DATABASE_URL: "postgresql+psycopg://postgres:${DB_PASSWORD}@db:5432/monitoring"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    stop_grace_period: 60s
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.workers.celery_app.celery inspect ping --timeout=5 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - private
    deploy:
      resources:
        limits:
          memory: 400M
        reservations:
          memory: 200M

  # ---------------------------------------------------------------------------
  # Celery Beat Scheduler
  # ---------------------------------------------------------------------------
  beat:
    <<: *app-common
    command:
      - celery
      - -A
      - app.workers.celery_app.celery
      - beat
      - -l
      - info
      - --schedule
      - /tmp/celerybeat-schedule
      - --pidfile
      - /tmp/celerybeat.pid
    environment:
      DATABASE_URL: "postgresql+psycopg://postgres:${DB_PASSWORD}@db:5432/monitoring"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD-SHELL", "test -s /tmp/celerybeat.pid && pid=$$(cat /tmp/celerybeat.pid) && test -d /proc/$$pid"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - private
    deploy:
      resources:
        limits:
          memory: 150M
        reservations:
          memory: 80M

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    user: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: monitoring
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d monitoring"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - pg_data:/var/lib/postgresql/data
    tmpfs:
      - /tmp
      - /var/run/postgresql
    security_opt:
      - no-new-privileges:true
    restart: always
    networks:
      - private
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    deploy:
      resources:
        limits:
          memory: 200M
        reservations:
          memory: 100M

  # ---------------------------------------------------------------------------
  # Redis
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 100mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --appendonly no
    healthcheck:
      test: ["CMD", "sh", "-c", "redis-cli -a \"$REDIS_PASSWORD\" ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      - redis_data:/data
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    networks:
      - private
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    deploy:
      resources:
        limits:
          memory: 150M
        reservations:
          memory: 100M

  # ---------------------------------------------------------------------------
  # Web Frontend (FastAPI SSR)
  # ---------------------------------------------------------------------------
  web:
    image: ${DOCKER_USERNAME}/monitoring-web:${VERSION:-latest}
    env_file: ../.env.production
    environment:
      API_BASE_URL: "http://api:8000"
      LOGIN_PATH: "/login"
      PUBLIC_PATHS: "/login,/static,/_health,/health"
      LOG_LEVEL: INFO
      NODE_OPTIONS: "--max-old-space-size=300"
      NEXT_TELEMETRY_DISABLED: "1"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/_health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    security_opt:
      - no-new-privileges:true
    restart: always
    networks:
      - public
      - private
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=monitoring-prod-public"
      
      # Router pour / (UI principale)
      - "traefik.http.routers.web.rule=Host(`neonmonitor.dockl.com`)"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.web.priority=1"
      - "traefik.http.routers.web.service=web"
      - "traefik.http.services.web.loadbalancer.server.port=3000"
      
      # Rate limiting web
      - "traefik.http.middlewares.web-ratelimit.ratelimit.average=30"
      - "traefik.http.middlewares.web-ratelimit.ratelimit.burst=50"
      
      # Security headers
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      
      - "traefik.http.routers.web.middlewares=web-ratelimit@docker,security-headers@docker"
    deploy:
      resources:
        limits:
          memory: 350M
        reservations:
          memory: 260M

  # ---------------------------------------------------------------------------
  # Traefik Reverse Proxy + Let's Encrypt
  # ---------------------------------------------------------------------------
  traefik:
    image: traefik:v3.2
    command:
      # API et Dashboard (sécurisé)
      - "--api.dashboard=true"
      - "--ping=true"
      
      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=monitoring-prod-public"
      
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      
      # Redirection HTTP -> HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      
      # Let's Encrypt (HTTP Challenge)
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-frederic.gilgarcia@gmail.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # IMPORTANT: décommenter la ligne suivante pour tester en staging
      # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
      
      # Logs
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik-acme:/letsencrypt
      - ./traefik-logs:/var/log/traefik
    restart: always
    networks:
      - public
      - private
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      # Dashboard Traefik sécurisé (basicauth)
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`neonmonitor.dockl.com`) && PathPrefix(`/traefik`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.service=api@internal"
      
      # BasicAuth (générer avec: htpasswd -nb admin password)
      # Exemple: admin:$apr1$xyz... (à remplacer)
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH:-admin:$$apr1$$8kV7qH2Y$$9Z8nF9eQ1xKZ0Q6X2eP.J0}"
      - "traefik.http.routers.traefik.middlewares=traefik-auth@docker"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 150M
        reservations:
          memory: 80M
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Monitoring Status Dashboard
  # ---------------------------------------------------------------------------
  status:
    image: ${DOCKER_USERNAME}/monitoring-status:${VERSION:-latest}
    restart: unless-stopped
    networks:
      - public
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:9100/health')\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=monitoring-prod-public"
      
      # Router pour /status/* sur michevre1.vps.webdock.cloud
      - "traefik.http.routers.status.rule=Host(`michevre1.vps.webdock.cloud`) && PathPrefix(`/status`)"
      - "traefik.http.routers.status.entrypoints=websecure"
      - "traefik.http.routers.status.tls=true"
      - "traefik.http.routers.status.tls.certresolver=letsencrypt"
      - "traefik.http.routers.status.service=status"
      - "traefik.http.services.status.loadbalancer.server.port=9100"
      
      # Strip /status prefix
      - "traefik.http.middlewares.status-strip.stripprefix.prefixes=/status"
      
      # Redirect / -> /status/ sur michevre1.vps.webdock.cloud
      - "traefik.http.routers.status-root.rule=Host(`michevre1.vps.webdock.cloud`) && Path(`/`)"
      - "traefik.http.routers.status-root.entrypoints=websecure"
      - "traefik.http.routers.status-root.tls=true"
      - "traefik.http.routers.status-root.tls.certresolver=letsencrypt"
      - "traefik.http.routers.status-root.middlewares=status-redirect@docker"
      - "traefik.http.middlewares.status-redirect.redirectregex.regex=^https://michevre1.vps.webdock.cloud/$$"
      - "traefik.http.middlewares.status-redirect.redirectregex.replacement=https://michevre1.vps.webdock.cloud/status/"
      
      - "traefik.http.routers.status.middlewares=status-strip@docker"
    deploy:
      resources:
        limits:
          memory: 120M
        reservations:
          memory: 60M

# =============================================================================
# Volumes
# =============================================================================
volumes:
  pg_data:
    driver: local
  redis_data:
    driver: local

# =============================================================================
# Networks (segmentation + external)
# =============================================================================
networks:
  public:
    external: true
    name: monitoring-prod-public
  private:
    external: true
    name: monitoring-prod-private