# server/Dockerfile.dev
# Image "dev" (editable install + extras) avec coverage pour lâ€™API_COVERAGE=1.

FROM python:3.11-slim-bookworm
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1 PIP_DISABLE_PIP_VERSION_CHECK=1 PYTHONPATH=/app/server DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends curl build-essential gcc \
 && rm -rf /var/lib/apt/lists/*

# Utilisateur non-root
RUN useradd -ms /bin/bash appuser

WORKDIR /app/server

COPY server/pyproject.toml /app/server/
RUN pip install --upgrade pip wheel setuptools
COPY server /app/server

# Install en mode dev + coverage
RUN pip install --no-cache-dir -e .[dev] \
 && pip install --no-cache-dir coverage

COPY server/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh && chown -R appuser:appuser /app

USER appuser
EXPOSE 8000
ENTRYPOINT ["/entrypoint.sh"]
