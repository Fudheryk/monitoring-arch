
################################################################################
#  SC√âNARIO MATRICE ALERTES / NO-DATA (cpu.usage_percent + memory.usage_percent)
#  Machine : debian-dev
#  Client  : Dev
#  Fingerprint : f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1
################################################################################

################################################################################
#  SC√âNARIO : 0 - Configuration initiale (SETUP)
################################################################################

üîß Configuration initiale de la machine et des seuils...

################################################################################
INGEST [setup-initial] ‚Üí http://localhost:8000/api/v1/ingest/metrics
################################################################################
Payload:
{
  "metadata": {
    "generator": "scenario-matrix-script",
    "version": "0.1",
    "schema_version": "1.0",
    "key": "dev-apikey-123"
  },
  "machine": {
    "hostname": "debian-dev",
    "os": "linux",
    "fingerprint": "f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1"
  },
  "metrics": [
    {
      "name": "cpu.usage_percent",
      "value": 20
    },
    {
      "name": "memory.usage_percent",
      "value": 30
    }
  ]
}
HTTP 202
{
  "status": "accepted",
  "ingest_id": "20260102_154604_6104560f:setup-initial"
}
[CHECK OK]   Ingestion 'setup-initial'

--------------------------------------------------------------------------------
‚è±  Attente 30s pour: cr√©ation des metric_instances
--------------------------------------------------------------------------------
  ... 30 s restantes
  ... 20 s restantes
  ... 10 s restantes
‚è±  Fin de l'attente.


üîß ACTIVATION DE L'ALERTING SUR LES M√âTRIQUES

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c UPDATE metric_instances SET is_alerting_enabled = true WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') );
================================================================================
UPDATE 2
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c UPDATE metric_instances SET is_alerting_enabled = true WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ); (exit_code=0)

üîß CR√âATION DU SEUIL POUR cpu.usage_percent

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -t -A -c SELECT id FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND name_effective = 'cpu.usage_percent';
================================================================================
4545cf93-e17b-4291-94d0-79e6a692285c
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -t -A -c SELECT id FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND name_effective = 'cpu.usage_percent'; (exit_code=0)

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -t -A -c SELECT COUNT(*) FROM thresholds_new WHERE metric_instance_id = '4545cf93-e17b-4291-94d0-79e6a692285c' AND name = 'default';
================================================================================
0
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -t -A -c SELECT COUNT(*) FROM thresholds_new WHERE metric_instance_id = '4545cf93-e17b-4291-94d0-79e6a692285c' AND name = 'default'; (exit_code=0)
‚ÑπÔ∏è  Cr√©ation d'un nouveau seuil DEFAULT pour cpu.usage_percent...

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c INSERT INTO thresholds_new (     id, metric_instance_id, name, condition, value_num,     severity, is_active, consecutive_breaches, created_at, updated_at ) VALUES (     gen_random_uuid(),     '4545cf93-e17b-4291-94d0-79e6a692285c',     'default',     'gt',     80.0,     'warning',     true,     1,     NOW(),     NOW() );
================================================================================
INSERT 0 1
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c INSERT INTO thresholds_new (     id, metric_instance_id, name, condition, value_num,     severity, is_active, consecutive_breaches, created_at, updated_at ) VALUES (     gen_random_uuid(),     '4545cf93-e17b-4291-94d0-79e6a692285c',     'default',     'gt',     80.0,     'warning',     true,     1,     NOW(),     NOW() ); (exit_code=0)
[CHECK OK]   Configuration seuil DEFAULT cpu.usage_percent

üîß CR√âATION DU SEUIL POUR memory.usage_percent

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -t -A -c SELECT id FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND name_effective = 'memory.usage_percent';
================================================================================
4da38dea-9136-45e5-91d4-1830272a345a
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -t -A -c SELECT id FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND name_effective = 'memory.usage_percent'; (exit_code=0)

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -t -A -c SELECT COUNT(*) FROM thresholds_new WHERE metric_instance_id = '4da38dea-9136-45e5-91d4-1830272a345a' AND name = 'default';
================================================================================
0
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -t -A -c SELECT COUNT(*) FROM thresholds_new WHERE metric_instance_id = '4da38dea-9136-45e5-91d4-1830272a345a' AND name = 'default'; (exit_code=0)
‚ÑπÔ∏è  Cr√©ation d'un nouveau seuil DEFAULT pour memory.usage_percent...

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c INSERT INTO thresholds_new (     id, metric_instance_id, name, condition, value_num,     severity, is_active, consecutive_breaches, created_at, updated_at ) VALUES (     gen_random_uuid(),     '4da38dea-9136-45e5-91d4-1830272a345a',     'default',     'gt',     85.0,     'warning',     true,     1,     NOW(),     NOW() );
================================================================================
INSERT 0 1
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c INSERT INTO thresholds_new (     id, metric_instance_id, name, condition, value_num,     severity, is_active, consecutive_breaches, created_at, updated_at ) VALUES (     gen_random_uuid(),     '4da38dea-9136-45e5-91d4-1830272a345a',     'default',     'gt',     85.0,     'warning',     true,     1,     NOW(),     NOW() ); (exit_code=0)
[CHECK OK]   Configuration seuil DEFAULT memory.usage_percent

üìä √âTAT DES METRICS

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, machine_id, name_effective, is_alerting_enabled, needs_threshold,        is_paused, last_value, updated_at FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY name_effective;
================================================================================
                  id                  |              machine_id              |    name_effective    | is_alerting_enabled | needs_threshold | is_paused | last_value |       updated_at       
--------------------------------------+--------------------------------------+----------------------+---------------------+-----------------+-----------+------------+------------------------
 4545cf93-e17b-4291-94d0-79e6a692285c | 77380be9-8ce2-4497-b1ee-4f6ab1159ba4 | cpu.usage_percent    | t                   | t               | f         | 20.0       | 2026-01-02 14:46:04+00
 4da38dea-9136-45e5-91d4-1830272a345a | 77380be9-8ce2-4497-b1ee-4f6ab1159ba4 | memory.usage_percent | t                   | t               | f         | 30.0       | 2026-01-02 14:46:04+00
(2 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, machine_id, name_effective, is_alerting_enabled, needs_threshold,        is_paused, last_value, updated_at FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY name_effective; (exit_code=0)

‚öôÔ∏è  SEUILS CONFIGUR√âS

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT t.id, mi.name_effective, t.name, t.condition, t.value_num,        t.severity, t.is_active, t.created_at FROM thresholds_new t JOIN metric_instances mi ON mi.id = t.metric_instance_id WHERE mi.machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY mi.name_effective, t.name;
================================================================================
                  id                  |    name_effective    |  name   | condition | value_num | severity | is_active |          created_at           
--------------------------------------+----------------------+---------+-----------+-----------+----------+-----------+-------------------------------
 927b8229-6b4f-4ae4-a29e-539be5b7f5e3 | cpu.usage_percent    | default | gt        |        80 | warning  | t         | 2026-01-02 14:46:37.51173+00
 10974296-dd3a-4c01-8c2c-b25f46b6e773 | memory.usage_percent | default | gt        |        85 | warning  | t         | 2026-01-02 14:46:39.557626+00
(2 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT t.id, mi.name_effective, t.name, t.condition, t.value_num,        t.severity, t.is_active, t.created_at FROM thresholds_new t JOIN metric_instances mi ON mi.id = t.metric_instance_id WHERE mi.machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY mi.name_effective, t.name; (exit_code=0)

>>> R√©sultat du sc√©nario '0 - Configuration initiale (SETUP)': SUCCESS ‚úÖ


################################################################################
#  SC√âNARIO : 1 - Onboarding CPU
################################################################################

################################################################################
INGEST [cpu-onboarding-1] ‚Üí http://localhost:8000/api/v1/ingest/metrics
################################################################################
Payload:
{
  "metadata": {
    "generator": "scenario-matrix-script",
    "version": "0.1",
    "schema_version": "1.0",
    "key": "dev-apikey-123"
  },
  "machine": {
    "hostname": "debian-dev",
    "os": "linux",
    "fingerprint": "f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1"
  },
  "metrics": [
    {
      "name": "cpu.usage_percent",
      "value": 42
    }
  ]
}
HTTP 202
{
  "status": "accepted",
  "ingest_id": "20260102_154604_6104560f:cpu-onboarding-1"
}
[CHECK OK]   Ingestion 'cpu-onboarding-1'

--------------------------------------------------------------------------------
‚è±  Attente 60s pour: laisser l'ingestion √™tre trait√©e
--------------------------------------------------------------------------------
  ... 60 s restantes
  ... 50 s restantes
  ... 40 s restantes
  ... 30 s restantes
  ... 20 s restantes
  ... 10 s restantes
‚è±  Fin de l'attente.


üìä √âTAT DES METRICS

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, machine_id, name_effective, is_alerting_enabled, needs_threshold,        is_paused, last_value, updated_at FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY name_effective;
================================================================================
                  id                  |              machine_id              |    name_effective    | is_alerting_enabled | needs_threshold | is_paused | last_value |       updated_at       
--------------------------------------+--------------------------------------+----------------------+---------------------+-----------------+-----------+------------+------------------------
 4545cf93-e17b-4291-94d0-79e6a692285c | 77380be9-8ce2-4497-b1ee-4f6ab1159ba4 | cpu.usage_percent    | t                   | t               | f         | 42.0       | 2026-01-02 14:46:41+00
 4da38dea-9136-45e5-91d4-1830272a345a | 77380be9-8ce2-4497-b1ee-4f6ab1159ba4 | memory.usage_percent | t                   | t               | f         | 30.0       | 2026-01-02 14:46:04+00
(2 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, machine_id, name_effective, is_alerting_enabled, needs_threshold,        is_paused, last_value, updated_at FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY name_effective; (exit_code=0)

üö® √âTAT DES INCIDENTS (machine)

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY created_at DESC;
================================================================================
 id | client_id | machine_id | title | severity | status | created_at | resolved_at 
----+-----------+------------+-------+----------+--------+------------+-------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY created_at DESC; (exit_code=0)

üö® √âTAT DES INCIDENTS DE SEUIL

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND title LIKE '%breach%' ORDER BY created_at DESC;
================================================================================
 id | client_id | machine_id | title | severity | status | created_at | resolved_at 
----+-----------+------------+-------+----------+--------+------------+-------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND title LIKE '%breach%' ORDER BY created_at DESC; (exit_code=0)

‚ö†Ô∏è  √âTAT DES ALERTES DE SEUIL

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, threshold_id, machine_id, metric_instance_id, status, severity,        current_value, triggered_at, resolved_at, created_at FROM alerts WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY created_at DESC LIMIT 50;
================================================================================
 id | threshold_id | machine_id | metric_instance_id | status | severity | current_value | triggered_at | resolved_at | created_at 
----+--------------+------------+--------------------+--------+----------+---------------+--------------+-------------+------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, threshold_id, machine_id, metric_instance_id, status, severity,        current_value, triggered_at, resolved_at, created_at FROM alerts WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY created_at DESC LIMIT 50; (exit_code=0)

‚úâÔ∏è  DERNI√àRES NOTIFICATIONS

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, incident_id, alert_id, provider, recipient,        status, message, sent_at, created_at FROM notification_log WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev') ORDER BY created_at DESC LIMIT 20;
================================================================================
 id | client_id | incident_id | alert_id | provider | recipient | status | message | sent_at | created_at 
----+-----------+-------------+----------+----------+-----------+--------+---------+---------+------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, incident_id, alert_id, provider, recipient,        status, message, sent_at, created_at FROM notification_log WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev') ORDER BY created_at DESC LIMIT 20; (exit_code=0)

>>> R√©sultat du sc√©nario '1 - Onboarding CPU': SUCCESS ‚úÖ


################################################################################
#  SC√âNARIO : 2 - NO-DATA machine DOWN
################################################################################

--------------------------------------------------------------------------------
‚è±  Attente 320s pour: laisser NO-DATA se d√©clencher (machine DOWN)
--------------------------------------------------------------------------------
  ... 320 s restantes
  ... 310 s restantes
  ... 300 s restantes
  ... 290 s restantes
  ... 280 s restantes
  ... 270 s restantes
  ... 260 s restantes
  ... 250 s restantes
  ... 240 s restantes
  ... 230 s restantes
  ... 220 s restantes
  ... 210 s restantes
  ... 200 s restantes
  ... 190 s restantes
  ... 180 s restantes
  ... 170 s restantes
  ... 160 s restantes
  ... 150 s restantes
  ... 140 s restantes
  ... 130 s restantes
  ... 120 s restantes
  ... 110 s restantes
  ... 100 s restantes
  ... 90 s restantes
  ... 80 s restantes
  ... 70 s restantes
  ... 60 s restantes
  ... 50 s restantes
  ... 40 s restantes
  ... 30 s restantes
  ... 20 s restantes
  ... 10 s restantes
‚è±  Fin de l'attente.


üìä √âTAT DES METRICS

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, machine_id, name_effective, is_alerting_enabled, needs_threshold,        is_paused, last_value, updated_at FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY name_effective;
================================================================================
                  id                  |              machine_id              |    name_effective    | is_alerting_enabled | needs_threshold | is_paused | last_value |       updated_at       
--------------------------------------+--------------------------------------+----------------------+---------------------+-----------------+-----------+------------+------------------------
 4545cf93-e17b-4291-94d0-79e6a692285c | 77380be9-8ce2-4497-b1ee-4f6ab1159ba4 | cpu.usage_percent    | t                   | t               | f         | 42.0       | 2026-01-02 14:46:41+00
 4da38dea-9136-45e5-91d4-1830272a345a | 77380be9-8ce2-4497-b1ee-4f6ab1159ba4 | memory.usage_percent | t                   | t               | f         | 30.0       | 2026-01-02 14:46:04+00
(2 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, machine_id, name_effective, is_alerting_enabled, needs_threshold,        is_paused, last_value, updated_at FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY name_effective; (exit_code=0)

üö® √âTAT DES INCIDENTS (machine)

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY created_at DESC;
================================================================================
 id | client_id | machine_id | title | severity | status | created_at | resolved_at 
----+-----------+------------+-------+----------+--------+------------+-------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY created_at DESC; (exit_code=0)

üö® √âTAT DES INCIDENTS 'Metric no data'

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND title LIKE '%Metric no data%' ORDER BY created_at DESC;
================================================================================
 id | client_id | machine_id | title | severity | status | created_at | resolved_at 
----+-----------+------------+-------+----------+--------+------------+-------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND title LIKE '%Metric no data%' ORDER BY created_at DESC; (exit_code=0)

‚úâÔ∏è  DERNI√àRES NOTIFICATIONS

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, incident_id, alert_id, provider, recipient,        status, message, sent_at, created_at FROM notification_log WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev') ORDER BY created_at DESC LIMIT 20;
================================================================================
 id | client_id | incident_id | alert_id | provider | recipient | status | message | sent_at | created_at 
----+-----------+-------------+----------+----------+-----------+--------+---------+---------+------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, incident_id, alert_id, provider, recipient,        status, message, sent_at, created_at FROM notification_log WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev') ORDER BY created_at DESC LIMIT 20; (exit_code=0)

>>> R√©sultat du sc√©nario '2 - NO-DATA machine DOWN': SUCCESS ‚úÖ


################################################################################
#  SC√âNARIO : 3 - Restauration compl√®te machine
################################################################################

################################################################################
INGEST [cpu-restore-full] ‚Üí http://localhost:8000/api/v1/ingest/metrics
################################################################################
Payload:
{
  "metadata": {
    "generator": "scenario-matrix-script",
    "version": "0.1",
    "schema_version": "1.0",
    "key": "dev-apikey-123"
  },
  "machine": {
    "hostname": "debian-dev",
    "os": "linux",
    "fingerprint": "f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1"
  },
  "metrics": [
    {
      "name": "cpu.usage_percent",
      "value": 30
    }
  ]
}
HTTP 202
{
  "status": "accepted",
  "ingest_id": "20260102_154604_6104560f:cpu-restore-full"
}
[CHECK OK]   Ingestion 'cpu-restore-full'

--------------------------------------------------------------------------------
‚è±  Attente 60s pour: laisser freshness/evaluate traiter la restauration
--------------------------------------------------------------------------------
  ... 60 s restantes
  ... 50 s restantes
  ... 40 s restantes
  ... 30 s restantes
  ... 20 s restantes
  ... 10 s restantes
‚è±  Fin de l'attente.


üìä √âTAT DES METRICS

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, machine_id, name_effective, is_alerting_enabled, needs_threshold,        is_paused, last_value, updated_at FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY name_effective;
================================================================================
                  id                  |              machine_id              |    name_effective    | is_alerting_enabled | needs_threshold | is_paused | last_value |       updated_at       
--------------------------------------+--------------------------------------+----------------------+---------------------+-----------------+-----------+------------+------------------------
 4545cf93-e17b-4291-94d0-79e6a692285c | 77380be9-8ce2-4497-b1ee-4f6ab1159ba4 | cpu.usage_percent    | t                   | t               | f         | 30.0       | 2026-01-02 14:53:07+00
 4da38dea-9136-45e5-91d4-1830272a345a | 77380be9-8ce2-4497-b1ee-4f6ab1159ba4 | memory.usage_percent | t                   | t               | f         | 30.0       | 2026-01-02 14:46:04+00
(2 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, machine_id, name_effective, is_alerting_enabled, needs_threshold,        is_paused, last_value, updated_at FROM metric_instances WHERE machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY name_effective; (exit_code=0)

üö® √âTAT DES INCIDENTS (machine)

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY created_at DESC;
================================================================================
 id | client_id | machine_id | title | severity | status | created_at | resolved_at 
----+-----------+------------+-------+----------+--------+------------+-------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') ) ORDER BY created_at DESC; (exit_code=0)

üö® √âTAT DES INCIDENTS 'Metric no data'

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND title LIKE '%Metric no data%' ORDER BY created_at DESC;
================================================================================
 id | client_id | machine_id | title | severity | status | created_at | resolved_at 
----+-----------+------------+-------+----------+--------+------------+-------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, machine_id, title, severity, status,        created_at, resolved_at FROM incidents WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev')   AND machine_id = ( SELECT id FROM machines WHERE hostname = 'debian-dev'   AND fingerprint = 'f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1'   AND client_id = (SELECT id FROM clients WHERE name = 'Dev') )   AND title LIKE '%Metric no data%' ORDER BY created_at DESC; (exit_code=0)

‚úâÔ∏è  DERNI√àRES NOTIFICATIONS

================================================================================
>> CMD: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, incident_id, alert_id, provider, recipient,        status, message, sent_at, created_at FROM notification_log WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev') ORDER BY created_at DESC LIMIT 20;
================================================================================
 id | client_id | incident_id | alert_id | provider | recipient | status | message | sent_at | created_at 
----+-----------+-------------+----------+----------+-----------+--------+---------+---------+------------
(0 rows)
[CHECK OK]   Commande: docker compose -f docker/docker-compose.yml exec -T db psql -U postgres -d monitoring -c SELECT id, client_id, incident_id, alert_id, provider, recipient,        status, message, sent_at, created_at FROM notification_log WHERE client_id = (SELECT id FROM clients WHERE name = 'Dev') ORDER BY created_at DESC LIMIT 20; (exit_code=0)

>>> R√©sultat du sc√©nario '3 - Restauration compl√®te machine': SUCCESS ‚úÖ


################################################################################
#  SC√âNARIO : 4 - Ajout memory.usage_percent
################################################################################

################################################################################
INGEST [cpu-mem-onboarding] ‚Üí http://localhost:8000/api/v1/ingest/metrics
################################################################################
Payload:
{
  "metadata": {
    "generator": "scenario-matrix-script",
    "version": "0.1",
    "schema_version": "1.0",
    "key": "dev-apikey-123"
  },
  "machine": {
    "hostname": "debian-dev",
    "os": "linux",
    "fingerprint": "f5355ba885eceec3b226bf1c746d7159baa891d9b47aa6d07369a47a8e4d5cc1"
  },
  "metrics": [
    {
      "name": "cpu.usage_percent",
      "value": 35
    },
    {
      "name": "memory.usage_percent",
      "value": 40
    }
  ]
}
HTTP 202
{
  "status": "accepted",
  "ingest_id": "20260102_154604_6104560f:cpu-mem-onboarding"
}
[CHECK OK]   Ingestion 'cpu-mem-onboarding'

--------------------------------------------------------------------------------
‚è±  Attente 60s pour: traitement de l'ingestion CPU+MEM
--------------------------------------------------------------------------------
  ... 60 s restantes
  ... 50 s restantes
  ... 40 s restantes
  ... 30 s restantes
  ... 20 s restantes
  ... 10 s restantes
