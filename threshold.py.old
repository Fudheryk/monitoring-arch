from __future__ import annotations
"""
server/app/infrastructure/persistence/database/models/threshold.py
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Modèle SQLAlchemy pour la table `thresholds` (seuils d’alerte).

Schéma BDD rappelé :

    op.create_table(
        "thresholds",
        sa.Column("id", UUIDType, primary_key=True),
        sa.Column("metric_instance_id", UUIDType, nullable=False),
        sa.Column("name", sa.String(100), nullable=False),
        sa.Column("condition", sa.String(32), nullable=False),
        sa.Column("value_num", sa.Float(), nullable=True),
        sa.Column("value_bool", sa.Boolean(), nullable=True),
        sa.Column("value_str", sa.String(255), nullable=True),
        sa.Column("severity", sa.String(16), server_default="warning", nullable=False),
        sa.Column("is_active", sa.Boolean(), server_default=sa.text("TRUE"), nullable=False),
        sa.Column("consecutive_breaches", sa.Integer(), server_default="1", nullable=False),
        sa.Column("cooldown_sec", sa.Integer(), server_default="0", nullable=False),
        sa.Column("min_duration_sec", sa.Integer(), server_default="0", nullable=False),
        sa.Column("created_at", TSTZ, server_default=now_sql, nullable=False),
        sa.Column("updated_at", TSTZ, server_default=now_sql, nullable=False),
        sa.ForeignKeyConstraint(["metric_instance_id"], ["metrics.id"], ondelete="CASCADE"),
    )

    op.create_unique_constraint(
        "uq_thresholds_metric_id_name",
        "thresholds",
        ["metric_id", "name"],
    )
"""

import uuid
import datetime as dt

from sqlalchemy import Boolean, DateTime, Float, ForeignKey, Integer, String
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import Mapped, mapped_column

from app.infrastructure.persistence.database.base import Base


def _utcnow() -> dt.datetime:
    """Helper UTC pour les timestamps (default / onupdate)."""
    return dt.datetime.now(dt.timezone.utc)


class Threshold(Base):
    """
    Seuil d'évaluation pour une métrique.

    Quelques conventions :
    - Un seuil appartient à une Metric (metric_instance_id).
    - (metric_instance_id, name) est unique (cf. contrainte SQL) :
        * "default"  → seuil principal configuré par l’utilisateur.
    - Selon le type de la Metric (number/bool/string), un seul champ
      parmi value_num / value_bool / value_str doit être renseigné.
    """
    __tablename__ = "thresholds"

    # ------------------------------------------------------------------
    # Identité & relation à la métrique
    # ------------------------------------------------------------------
    id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
    )

    metric_instance_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("metrics.id", ondelete="CASCADE"),
        index=True,
    )

    # ------------------------------------------------------------------
    # Définition du seuil
    # ------------------------------------------------------------------
    # Nom logique du seuil (ex: "default", "suggested_high", "night_mode", ...)
    name: Mapped[str] = mapped_column(String(100))

    # Condition de comparaison :
    #   - nombre : gt, ge, lt, le, eq, ne
    #   - bool   : eq, ne
    #   - string : eq, ne, contains, not_contains, regex
    condition: Mapped[str] = mapped_column(String(32))

    # Valeur numérique du seuil (pour metrics type "numeric")
    value_num: Mapped[float | None] = mapped_column(Float, nullable=True)

    # Valeur booléenne du seuil (pour metrics type "boolean")
    value_bool: Mapped[bool | None] = mapped_column(Boolean, nullable=True)

    # Valeur texte du seuil (pour metrics type "string")
    value_str: Mapped[str | None] = mapped_column(String(255), nullable=True)

    # Niveau de sévérité de l’alerte (warning / critical / info ...)
    severity: Mapped[str] = mapped_column(
        String(16),
        default="warning",
    )

    # ------------------------------------------------------------------
    # Flags métier
    # ------------------------------------------------------------------
    # is_active = FALSE permet de désactiver ce seuil sans le supprimer.
    is_active: Mapped[bool] = mapped_column(
        Boolean,
        default=True,
    )

    # ------------------------------------------------------------------
    # Paramètres d’évaluation
    # ------------------------------------------------------------------
    # Nombre de fois consécutives où la condition doit être vraie
    # avant de considérer le seuil comme "en violation".
    consecutive_breaches: Mapped[int] = mapped_column(
        Integer,
        default=1,
    )

    # Délai de cooldown (en secondes) après le déclenchement d’un incident,
    # pendant lequel on ne renvoie pas de nouvelle alerte identique.
    cooldown_sec: Mapped[int] = mapped_column(
        Integer,
        default=0,
    )

    # Durée minimale (en secondes) pendant laquelle la condition doit rester vraie
    # avant de considérer l’alerte comme déclenchée (anti-flap).
    min_duration_sec: Mapped[int] = mapped_column(
        Integer,
        default=0,
    )

    # ------------------------------------------------------------------
    # Timestamps
    # ------------------------------------------------------------------
    created_at: Mapped[dt.datetime] = mapped_column(
        DateTime(timezone=True),
        default=_utcnow,
    )

    updated_at: Mapped[dt.datetime] = mapped_column(
        DateTime(timezone=True),
        default=_utcnow,
        onupdate=_utcnow,
    )
