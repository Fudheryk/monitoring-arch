[pytest]
minversion = 8.0

# ⚠️ --cov est activé par défaut ici. Si tu lances pytest avec
#     -p no:cov, enlève ces 3 options en surchargeant via :
#     PYTEST_ADDOPTS="-q -ra --strict-markers --strict-config --durations=20" pytest
addopts = --cov=server/app --cov-config=.coveragerc --cov-report=term-missing -q -ra --strict-markers --strict-config --durations=20

testpaths =
    server/tests

# Importer "server" à la racine pour avoir "app.*" importable partout
pythonpath =
    .
    server

markers =
    unit: fast unit tests / tests unitaires rapides (no external services)
    integration: tests requiring DB/Redis/API/worker / tests avec Postgres/Redis (services)
    e2e: end-to-end tests on full stack / tests bout-à-bout (stack docker up)
    timeout: limite par test (secondes) fournie par pytest-timeout

filterwarnings =
    ignore::DeprecationWarning

# Timeouts par défaut
timeout = 60
timeout_method = thread
timeout_func_only = true

# Valeurs d'environnement par défaut (côté host uniquement)
env =
  INTEG_STACK_UP=0
  E2E_STACK_UP=0
  STUB_SLACK=1
  # Webhook "no-op" côté host; les containers (override dev) gèrent aussi le stub.
  SLACK_WEBHOOK=http://httpbin:80/status/204
  # Exécuter les tâches Celery en eager pour les tests unitaires côté host
  CELERY_TASK_ALWAYS_EAGER=1
  ALERT_REMINDER_MINUTES=1
  DATABASE_URL=sqlite+pysqlite:///:memory:
  REDIS_URL=redis://localhost:6379/0

